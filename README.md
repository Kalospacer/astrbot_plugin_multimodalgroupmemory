# MultimodalGroupMemory - 群聊图片记忆插件

> 让你的 AstrBot 在群聊中**看得见图片、记得住图片**。

---

## 这个插件是干什么的？

在群聊里，经常有人先发图片、过一会儿再 @机器人 问"这张图是什么"。但默认情况下，机器人只能看到 @它 那一条消息，**之前的图片它根本看不到**。

这个插件解决的就是这个问题：

- 自动记录群聊中所有人发的文字、@、图片
- **第一次看到的图片** -> 直接发给 AI 模型看（原生注入）
- **已经看过的图片** -> 用文字描述代替（比如 `[Image: 一只猫坐在沙发上]`）
- **临时图片链接过期？没关系** -> 收到图片时立刻下载保存到本地
- **图片太大？** -> 自动缩放和压缩，确保不会因为图片过大导致 API 报错

---

## 安装

在 AstrBot 管理面板 -> 插件管理 -> 搜索 `multimodalgroupmemory` -> 安装即可。

---

## 安装后必做：关闭内置群聊记忆

这个插件会**接管**群聊记忆功能。如果不关闭 AstrBot 内置的群聊记忆，两边会重复注入，导致 AI 收到两份重复的聊天记录。

**操作步骤：**

1. 打开 AstrBot 管理面板
2. 进入 **配置** 页面
3. 找到 `provider_ltm_settings`（提供商长期记忆设置）
4. 把 **`group_icl_enable`** 设为 `false`（关闭群聊上下文注入）
5. 把 **`active_reply`** 里的 **`enable`** 设为 `false`（关闭主动回复）
6. 保存配置

> 如果你忘了关，插件会在日志里反复提醒你，不会崩溃，但效果会打折扣。

---

## 配置说明

安装插件后，在 AstrBot 管理面板 -> 插件管理 -> 找到本插件 -> 点击 **配置**，可以看到以下选项：

### 基础配置

| 配置项 | 说明 | 默认值 | 建议 |
|--------|------|--------|------|
| **启用群聊上下文接管** | 插件的总开关。关掉后插件完全不工作。 | 开启 | 保持开启 |
| **群聊记忆最大消息数量** | 插件最多记住最近多少条群聊消息。超出后最早的消息会被丢弃。 | `300` | 一般不用改。群特别活跃可以改大一点（比如 `500`），但太大会让发给 AI 的上下文太长。 |

### 图片相关配置

| 配置项 | 说明 | 默认值 | 建议 |
|--------|------|--------|------|
| **图片扫描历史窗口** | 每次 AI 回复时，从最近多少条消息里挑选图片。 | `5` | 改大可以让 AI 看到更早的图片，但也会增加消耗。一般 `3`~`8` 即可。 |
| **每轮原生注入图片上限** | 每次调用 AI 时，最多同时发几张图片给它看。 | `2` | 发太多图片会增加 Token 消耗和延迟。建议 `1`~`3`。如果你用的模型不支持多图，设为 `1`。 |
| **待注入图片最大等待轮数** | 如果一张图片这轮没轮到注入（超过上限了），它还能等几轮。超过后就放弃了。 | `2` | 一般不用改。设为 `0` 表示只有当轮消息里的图片才会被注入。 |

### 图片转述（高级功能）

当一张图片已经被 AI 看过一次后，再次出现时不会再原图发送，而是用一段文字描述代替。这个功能需要额外调用一次 AI 来生成描述。

| 配置项 | 说明 | 默认值 | 建议 |
|--------|------|--------|------|
| **复见图片自动转述** | 是否为已看过的图片生成文字描述。关闭则统一显示 `[Image]`。 | 关闭 | 如果你不在意额外的 AI 调用消耗，可以开启，效果会更好。 |
| **图片转述模型** | 用哪个模型来描述图片。需要选择一个支持图片理解的模型。 | 空（不启用） | 点击下拉框，选择你在 AstrBot 中已配置好的**视觉模型**（如 Qwen-VL、GPT-4o 等）。如果留空，即使开启了转述也不会生效。 |
| **图片转述提示词** | 发给转述模型的提示语，告诉它怎么描述这张图。 | `Please describe the image using Chinese.` | 可以根据需要改成中文，比如 `请用简短的中文描述这张图片的内容。` |

---

## 配置示例

### 最简配置（推荐新手）

什么都不用改，装完插件、关掉Astrbot内置群聊记忆就行了。默认值已经是一套合理的配置。

---

## 图片处理说明

插件会自动对图片进行以下处理，你不需要操心：

- **格式验证**：只接受 JPEG、PNG、BMP、WebP、TIFF、HEIC 格式的真实图片
- **自动缩放**：超过 4K 分辨率的图片会自动等比缩小
- **自动压缩**：确保文件不超过 10MB
- **本地缓存**：图片会下载到本地 `data/plugin_data/` 目录下，不怕平台链接过期
- **自动清理**：插件启动时自动清理超过 24 小时的旧缓存；用户发 `/reset` 或 `/new` 重置会话时也会清理对应的缓存文件
- **宽高比检查**：极端比例（超过 200:1）的图片会被跳过
- **最小尺寸**：宽或高小于 10 像素的图片会被跳过

---

## 常见问题

**Q：装了插件后 AI 回复变慢了？**

因为现在 AI 不只看文字，还要看图片了。图片会消耗额外的 Token。可以把「每轮原生注入图片上限」调小（比如 `1`）。

**Q：AI 说"我看不到图片"？**

检查你用的 AI 模型是否支持图片理解（多模态）。纯文字模型（如 Deepseek3.2）看不了图,推荐的模型：Kimi-K2.5,Qwen3.5,Gemini/Claude/Grok/GPT都是原生多模态。

**Q：日志里一直出现 "Recommend turning off built-in LTM" 警告？**

说明你还没关闭 AstrBot 内置的群聊记忆。参考上面的「安装后必做」步骤。

**Q：图片转述功能开了但没效果？**

确认「图片转述模型」是否选择了一个有效的视觉模型。留空的话转述不会生效。

---

## 支持平台

目前适配了 **aiocqhttp**（OneBot v11 协议，QQ 个人号）。

## 许可证

MIT License
